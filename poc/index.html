<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise PS5 WebAssembly - C√≥digo Fonte</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(30, 30, 46, 0.95);
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-bottom: 2px solid #00adb5;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            color: #00adb5;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .tabs {
            display: flex;
            background: #1a1a2e;
            border-bottom: 2px solid #00adb5;
        }
        
        .tab {
            padding: 20px 30px;
            cursor: pointer;
            font-weight: bold;
            color: #aaa;
            border-right: 1px solid #2a2a3e;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: #2a2a3e;
            color: #fff;
        }
        
        .tab.active {
            background: #00adb5;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            min-height: 600px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .file-tree {
            background: #1a1a2e;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            padding: 5px 10px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-item:hover {
            background: #2a2a3e;
        }
        
        .file-item.critical {
            color: #ff6b6b;
            font-weight: bold;
        }
        
        .file-item.important {
            color: #4ecdc4;
        }
        
        .file-item.js::before {
            content: "üìÑ ";
            color: #f7dc6f;
        }
        
        .file-item.folder::before {
            content: "üìÅ ";
            color: #00adb5;
        }
        
        .code-viewer {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            color: #d4d4d4;
            margin-top: 20px;
        }
        
        .code-keyword {
            color: #569cd6;
        }
        
        .code-string {
            color: #ce9178;
        }
        
        .code-comment {
            color: #6a9955;
        }
        
        .code-function {
            color: #dcdcaa;
        }
        
        .code-number {
            color: #b5cea8;
        }
        
        .analysis-section {
            background: rgba(26, 26, 46, 0.8);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #00adb5;
        }
        
        .analysis-section h3 {
            color: #00adb5;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vulnerability-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .vulnerability-card {
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid #ff6b6b;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .vulnerability-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.2);
        }
        
        .vulnerability-card h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vulnerability-card.potential {
            background: rgba(78, 205, 196, 0.1);
            border-color: #4ecdc4;
        }
        
        .vulnerability-card.potential h4 {
            color: #4ecdc4;
        }
        
        .vulnerability-card.exploited {
            background: rgba(247, 220, 111, 0.1);
            border-color: #f7dc6f;
        }
        
        .vulnerability-card.exploited h4 {
            color: #f7dc6f;
        }
        
        .api-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .api-table th {
            background: #00adb5;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .api-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #2a2a3e;
        }
        
        .api-table tr:hover {
            background: rgba(0, 173, 181, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-present {
            background: #4ecdc4;
            color: #1a1a2e;
        }
        
        .status-missing {
            background: #ff6b6b;
            color: white;
        }
        
        .status-unknown {
            background: #f7dc6f;
            color: #1a1a2e;
        }
        
        .test-button {
            background: linear-gradient(135deg, #00adb5 0%, #0077b6 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 10px 5px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 173, 181, 0.3);
        }
        
        .test-button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #c44569 100%);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }
        
        .console-output {
            background: #1a1a2e;
            border: 2px solid #00adb5;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            color: #d4d4d4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-right: none;
                border-bottom: 1px solid #2a2a3e;
            }
            
            .vulnerability-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç An√°lise Profunda - WebAssembly PS5 WebKit</h1>
            <p>Baseado no c√≥digo-fonte: JSTests/wasm/v8/ (Firmware 11.00)</p>
            <p style="color: #ff6b6b; margin-top: 10px; font-weight: bold;">
                ‚ö†Ô∏è CR√çTICO: WasmModuleBuilder existe mas WebAssembly est√° desativado no navegador
            </p>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('structure')">üìÅ Estrutura</div>
            <div class="tab" onclick="showTab('vulnerabilities')">üí£ Vulnerabilidades</div>
            <div class="tab" onclick="showTab('apis')">‚öôÔ∏è APIs</div>
            <div class="tab" onclick="showTab('exploits')">üéØ Exploits</div>
            <div class="tab" onclick="showTab('tests')">üß™ Testes</div>
        </div>
        
        <!-- Estrutura de Arquivos -->
        <div id="structure-tab" class="tab-content active">
            <h2 style="color: #00adb5; margin-bottom: 20px;">üìÅ Estrutura do Diret√≥rio JSTests/wasm/v8</h2>
            
            <div class="file-tree" id="fileTree">
                Carregando estrutura de arquivos...
            </div>
            
            <div class="analysis-section">
                <h3>üîé Insights da Estrutura</h3>
                <p>O diret√≥rio <code>JSTests/wasm/v8/</code> cont√©m testes automatizados do WebAssembly. Algumas observa√ß√µes importantes:</p>
                <ul style="margin-top: 15px; margin-left: 20px;">
                    <li><strong>Pasta <code>gc/</code>:</strong> Testes de Garbage Collection para tipos GC (structs, arrays)</li>
                    <li><strong>Pasta <code>js-api/</code>:</strong> Testes das APIs JavaScript do WebAssembly</li>
                    <li><strong>Arquivo <code>wasm-module-builder.js</code>:</strong> Biblioteca para constru√ß√£o de m√≥dulos WASM</li>
                    <li><strong>Arquivo <code>test-helper.js</code>:</strong> Fun√ß√µes auxiliares para testes</li>
                </ul>
            </div>
            
            <div class="analysis-section">
                <h3>üìù Arquivo Selecionado</h3>
                <div class="code-viewer" id="selectedFileContent">
                    Clique em um arquivo na √°rvore para ver seu conte√∫do...
                </div>
            </div>
        </div>
        
        <!-- Vulnerabilidades -->
        <div id="vulnerabilities-tab" class="tab-content">
            <h2 style="color: #00adb5; margin-bottom: 20px;">üí£ Vulnerabilidades Potenciais</h2>
            
            <div class="analysis-section">
                <h3>üö® An√°lise Baseada na Estrutura de Testes</h3>
                <p>Os testes revelam pontos vulner√°veis na implementa√ß√£o:</p>
            </div>
            
            <div class="vulnerability-list" id="vulnerabilitiesList">
                <!-- Vulnerabilidades ser√£o carregadas dinamicamente -->
            </div>
            
            <div class="analysis-section">
                <h3>üéØ Foco Principal para Explora√ß√£o</h3>
                <p>Considerando que <strong>WasmModuleBuilder est√° dispon√≠vel mas WebAssembly n√£o</strong>, focar em:</p>
                <ol style="margin-top: 15px; margin-left: 20px;">
                    <li>Vulnerabilidades no pr√≥prio WasmModuleBuilder</li>
                    <li>Corrup√ß√£o de estruturas TypeDefinition</li>
                    <li>Use-after-free no gerenciamento de tipos</li>
                    <li>Buffer overflow em arrays de campos</li>
                </ol>
            </div>
        </div>
        
        <!-- APIs -->
        <div id="apis-tab" class="tab-content">
            <h2 style="color: #00adb5; margin-bottom: 20px;">‚öôÔ∏è APIs do WasmModuleBuilder</h2>
            
            <table class="api-table">
                <thead>
                    <tr>
                        <th>API</th>
                        <th>Status no PS5</th>
                        <th>Import√¢ncia para Exploit</th>
                        <th>Testar</th>
                    </tr>
                </thead>
                <tbody id="apiTableBody">
                    <!-- APIs ser√£o carregadas dinamicamente -->
                </tbody>
            </table>
            
            <div class="analysis-section">
                <h3>üîß Teste de APIs</h3>
                <div>
                    <button class="test-button" onclick="testAllAPIs()">üß™ Testar Todas APIs</button>
                    <button class="test-button success" onclick="testCriticalAPIs()">üéØ Testar APIs Cr√≠ticas</button>
                    <button class="test-button danger" onclick="testExploitAPIs()">üí£ Testar APIs de Exploit</button>
                </div>
                <div class="console-output" id="apiTestOutput">
                    Resultados dos testes aparecer√£o aqui...
                </div>
            </div>
        </div>
        
        <!-- Exploits -->
        <div id="exploits-tab" class="tab-content">
            <h2 style="color: #00adb5; margin-bottom: 20px;">üéØ Exploits Baseados nos Testes</h2>
            
            <div class="analysis-section">
                <h3>üîç Explora√ß√£o de WasmModuleBuilder sem WebAssembly</h3>
                <p>Estrat√©gias baseadas nos testes do PS5:</p>
            </div>
            
            <div class="vulnerability-list">
                <div class="vulnerability-card exploited">
                    <h4>üéØ 1. Type Confusion em Structs</h4>
                    <p>Baseado em <code>gc/struct.js</code>. Criar structs com layouts diferentes para confundir o sistema de tipos.</p>
                    <button class="test-button" onclick="runStructConfusion()">Executar Teste</button>
                </div>
                
                <div class="vulnerability-card exploited">
                    <h4>üí• 2. Use-After-Free em TypeDefinition</h4>
                    <p>Explorar libera√ß√£o e reutiliza√ß√£o de defini√ß√µes de tipos no WasmModuleBuilder.</p>
                    <button class="test-button danger" onclick="runUseAfterFree()">Executar Teste</button>
                </div>
                
                <div class="vulnerability-card potential">
                    <h4>üìä 3. Heap Spraying com Arrays</h4>
                    <p>Baseado em <code>gc/array.js</code>. Criar muitos arrays para controlar layout da heap.</p>
                    <button class="test-button" onclick="runHeapSpray()">Executar Teste</button>
                </div>
                
                <div class="vulnerability-card potential">
                    <h4>üîó 4. Corrup√ß√£o de Refer√™ncias</h4>
                    <p>Baseado em <code>js-api/global.js</code>. Corromper refer√™ncias entre objetos.</p>
                    <button class="test-button" onclick="runRefCorruption()">Executar Teste</button>
                </div>
            </div>
            
            <div class="console-output" id="exploitOutput">
                Resultados dos exploits aparecer√£o aqui...
            </div>
        </div>
        
        <!-- Testes -->
        <div id="tests-tab" class="tab-content">
            <h2 style="color: #00adb5; margin-bottom: 20px;">üß™ Testes Baseados no C√≥digo-Fonte</h2>
            
            <div class="analysis-section">
                <h3>üìã Testes do PS5 WebKit</h3>
                <p>Reimplementando testes cr√≠ticos do c√≥digo-fonte:</p>
                
                <div style="margin-top: 20px;">
                    <button class="test-button success" onclick="runPSTest('struct-basic')">üèóÔ∏è Teste Struct B√°sica</button>
                    <button class="test-button success" onclick="runPSTest('global-ref')">üîó Teste Global com Refer√™ncia</button>
                    <button class="test-button" onclick="runPSTest('type-export')">üì§ Teste Exporta√ß√£o de Tipo</button>
                    <button class="test-button danger" onclick="runPSTest('stress-test')">üí• Teste de Estresse</button>
                </div>
            </div>
            
            <div class="console-output" id="testOutput">
                Resultados dos testes aparecer√£o aqui...
            </div>
            
            <div class="analysis-section">
                <h3>üìä An√°lise de Resultados</h3>
                <p>Comparando comportamento esperado vs real:</p>
                <div id="testAnalysis">
                    Aguardando execu√ß√£o de testes...
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE TABS
        // ============================================
        
        function showTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        // ============================================
        // ESTRUTURA DE ARQUIVOS
        // ============================================
        
        const fileStructure = {
            "resources/": {
                type: "folder",
                children: {
                    "wasm-module-builder.js": { type: "js", critical: true },
                    "test-helper.js": { type: "js", important: true },
                    "test-utils.js": { type: "js" }
                }
            },
            "gc/": {
                type: "folder",
                children: {
                    "struct.js": { type: "js", critical: true },
                    "array.js": { type: "js", important: true },
                    "type-reflection.js": { type: "js", important: true },
                    "subtyping.js": { type: "js" },
                    "cast.js": { type: "js" }
                }
            },
            "js-api/": {
                type: "folder",
                children: {
                    "global.js": { type: "js", important: true },
                    "memory.js": { type: "js" },
                    "module.js": { type: "js" },
                    "table.js": { type: "js" },
                    "instance.js": { type: "js" }
                }
            },
            "spec/": {
                type: "folder",
                children: {
                    "*.js": { type: "js" }
                }
            },
            "regression/": {
                type: "folder",
                children: {
                    "*.js": { type: "js" }
                }
            }
        };
        
        function renderFileTree(structure, parent = "", depth = 0) {
            let html = "";
            const indent = "  ".repeat(depth);
            
            for (const [name, info] of Object.entries(structure)) {
                if (info.type === "folder") {
                    html += `<div class="file-item folder" style="margin-left: ${depth * 20}px;" onclick="toggleFolder(this)">
                        ${indent}${name}
                    </div>`;
                    
                    if (info.children) {
                        html += `<div class="folder-content" style="display: none; margin-left: ${depth * 20 + 20}px;">
                            ${renderFileTree(info.children, parent + name, depth + 1)}
                        </div>`;
                    }
                } else if (info.type === "js") {
                    const classes = ["file-item", "js"];
                    if (info.critical) classes.push("critical");
                    if (info.important) classes.push("important");
                    
                    html += `<div class="${classes.join(' ')}" style="margin-left: ${depth * 20}px;" 
                              onclick="loadFileContent('${parent + name}', ${info.critical || false})">
                        ${indent}${name}
                    </div>`;
                }
            }
            
            return html;
        }
        
        function toggleFolder(element) {
            const nextSibling = element.nextElementSibling;
            if (nextSibling && nextSibling.classList.contains('folder-content')) {
                nextSibling.style.display = nextSibling.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function loadFileContent(filename, isCritical) {
            const contentDiv = document.getElementById('selectedFileContent');
            
            // Exemplos de conte√∫do baseado no arquivo
            const fileContents = {
                "resources/wasm-module-builder.js": `// WasmModuleBuilder - PS5 WebKit
// Este arquivo permite construir m√≥dulos WebAssembly

class WasmModuleBuilder {
    constructor() {
        this.types = [];
        this.functions = [];
        this.globals = [];
        this.exports = [];
    }
    
    addStruct(fields) {
        // Adiciona uma struct ao m√≥dulo
        const typeIndex = this.types.length;
        this.types.push({
            form: kWasmStructTypeForm,
            fields: fields
        });
        return typeIndex;
    }
    
    addGlobal(type, mutable, shared, init) {
        // Adiciona uma global
        const global = { type, mutable, shared, init };
        this.globals.push(global);
        return {
            exportAs: (name) => {
                this.exports.push({ name, kind: kExternalGlobal, index: this.globals.length - 1 });
                return this;
            }
        };
    }
    
    instantiate() {
        // Instancia o m√≥dulo (pode falhar sem WebAssembly)
        console.warn("WebAssembly n√£o dispon√≠vel para instancia√ß√£o");
        return { exports: {} };
    }
    
    // ... mais m√©todos
}

// Constantes importantes para o exploit
const kWasmStructTypeForm = 0x5f;
const kWasmArrayTypeForm = 0x5e;
const kGCPrefix = 0xfb;
const kExprStructNew = 0x00;
const kExprStructGet = 0x02;`,
                
                "gc/struct.js": `// Testes de Structs - Revela vulnerabilidades potenciais

load("resources/wasm-module-builder.js");

// Teste: Cria√ß√£o de structs com muitos campos
(function TestStructManyFields() {
    print("TestStructManyFields");
    
    let builder = new WasmModuleBuilder();
    let fields = [];
    
    // Criar struct com 100 campos (potencial overflow)
    for (let i = 0; i < 100; i++) {
        fields.push(makeField(kWasmI32, true));
    }
    
    let struct_index = builder.addStruct(fields);
    print("Struct com 100 campos criada: " + struct_index);
    
    // Tentar criar struct ainda maior
    try {
        let huge_fields = new Array(10000).fill(makeField(kWasmI32, true));
        let huge_index = builder.addStruct(huge_fields);
        print("‚ö†Ô∏è Struct enorme criada: " + huge_index);
    } catch (e) {
        print("‚úÖ Comportamento esperado: " + e.message);
    }
})();

// Teste: Type confusion entre structs similares
(function TestStructSimilar() {
    print("TestStructSimilar");
    
    let builder = new WasmModuleBuilder();
    
    // Criar duas structs quase id√™nticas
    let struct1 = builder.addStruct([
        makeField(kWasmI32, true),
        makeField(kWasmI64, false)
    ]);
    
    let struct2 = builder.addStruct([
        makeField(kWasmI32, true),
        makeField(kWasmF32, false)  // Tipo diferente!
    ]);
    
    print("Struct1: " + struct1 + ", Struct2: " + struct2);
    
    // Potencial type confusion se √≠ndices forem reutilizados
})();`,
                
                "js-api/global.js": `// Testes de WebAssembly.Global - Importante para refer√™ncias

load("resources/wasm-module-builder.js");

// Teste: Globais com tipos de refer√™ncia
(function TestGlobalReferenceTypes() {
    print("TestGlobalReferenceTypes");
    
    let builder = new WasmModuleBuilder();
    
    // Criar struct para refer√™ncia
    let struct_index = builder.addStruct([
        makeField(kWasmI64, true)
    ]);
    
    // Global com refnull
    builder.addGlobal(wasmRefNullType(struct_index), true, false, [
        kExprRefNull, ...wasmSignedLeb(struct_index, kMaxVarInt32Size)
    ]).exportAs("global_refnull");
    
    // Global com ref (n√£o-nulo)
    // Isso pode causar problemas se o tipo for inv√°lido
    try {
        builder.addGlobal(wasmRefType(struct_index), true, false, [
            kExprRefNull, ...wasmSignedLeb(struct_index, kMaxVarInt32Size)
        ]).exportAs("global_ref_bad");
        print("‚ö†Ô∏è Global com tipo inconsistente criada");
    } catch (e) {
        print("‚úÖ Erro esperado: " + e.message);
    }
})();

// Teste: M√∫ltiplas globais para heap shaping
(function TestMultipleGlobals() {
    print("TestMultipleGlobals");
    
    let builder = new WasmModuleBuilder();
    let struct_index = builder.addStruct([makeField(kWasmI32, true)]);
    
    // Criar muitas globais (potencial para heap spraying)
    for (let i = 0; i < 1000; i++) {
        builder.addGlobal(wasmRefNullType(struct_index), true, false, [
            kExprRefNull, ...wasmSignedLeb(struct_index, kMaxVarInt32Size)
        ]).exportAs("global_" + i);
    }
    
    print("1000 globais criadas para heap shaping");
})();`
            };
            
            const content = fileContents[filename] || 
                `// Conte√∫do do arquivo: ${filename}\n\n` +
                `Este arquivo cont√©m testes ou c√≥digo relacionado ao WebAssembly no PS5.\n` +
                (isCritical ? `\n‚ö†Ô∏è ARQUIVO CR√çTICO: Cont√©m c√≥digo relevante para explora√ß√£o de vulnerabilidades.` : "");
            
            contentDiv.innerHTML = `<div style="color: ${isCritical ? '#ff6b6b' : '#4ecdc4'}">
                üìÅ ${filename} ${isCritical ? '(CR√çTICO)' : ''}
            </div>
            <pre style="margin-top: 15px;">${content}</pre>`;
        }
        
        // ============================================
        // VULNERABILIDADES
        // ============================================
        
        const vulnerabilities = [
            {
                title: "Type Confusion em Structs",
                description: "Criar structs com layouts similares pode causar confus√£o de tipos no WasmModuleBuilder.",
                file: "gc/struct.js",
                severity: "critical",
                exploit: "runStructConfusion"
            },
            {
                title: "Use-After-Free em TypeDefinition",
                description: "Liberar e reutilizar defini√ß√µes de tipos pode causar UAF no gerenciamento de mem√≥ria.",
                file: "gc/type-reflection.js",
                severity: "critical",
                exploit: "runUseAfterFree"
            },
            {
                title: "Buffer Overflow em Arrays",
                description: "Criar arrays muito grandes pode causar overflow nos buffers internos.",
                file: "gc/array.js",
                severity: "high",
                exploit: "runHeapSpray"
            },
            {
                title: "Corrup√ß√£o de Refer√™ncias",
                description: "Manipular refer√™ncias entre objetos pode corromper estruturas internas.",
                file: "js-api/global.js",
                severity: "high",
                exploit: "runRefCorruption"
            },
            {
                title: "Heap Spraying com Globais",
                description: "Criar muitas globais para controlar o layout da heap.",
                file: "js-api/global.js",
                severity: "medium",
                exploit: "runHeapSpray"
            },
            {
                title: "Integer Overflow em √çndices",
                description: "√çndices muito grandes podem causar overflow em c√°lculos internos.",
                file: "resources/wasm-module-builder.js",
                severity: "medium",
                exploit: "runIntegerOverflow"
            }
        ];
        
        function renderVulnerabilities() {
            const container = document.getElementById('vulnerabilitiesList');
            let html = "";
            
            vulnerabilities.forEach(vuln => {
                const severityClass = {
                    critical: "exploited",
                    high: "exploited",
                    medium: "potential",
                    low: "potential"
                }[vuln.severity] || "potential";
                
                const severityColor = {
                    critical: "#ff6b6b",
                    high: "#ff6b6b",
                    medium: "#f7dc6f",
                    low: "#4ecdc4"
                }[vuln.severity];
                
                html += `
                <div class="vulnerability-card ${severityClass}">
                    <h4>üí£ ${vuln.title}</h4>
                    <p>${vuln.description}</p>
                    <p style="font-size: 0.9em; color: ${severityColor}; margin-top: 10px;">
                        Severidade: ${vuln.severity.toUpperCase()} | Arquivo: ${vuln.file}
                    </p>
                    <button class="test-button" onclick="${vuln.exploit}()">Testar Explora√ß√£o</button>
                </div>`;
            });
            
            container.innerHTML = html;
        }
        
        // ============================================
        // APIS
        // ============================================
        
        const apis = [
            { name: "WasmModuleBuilder", available: true, critical: true, test: "testWasmBuilder" },
            { name: "WebAssembly", available: false, critical: true, test: "testWebAssembly" },
            { name: "addStruct()", available: true, critical: true, test: "testAddStruct" },
            { name: "addArray()", available: true, critical: false, test: "testAddArray" },
            { name: "addGlobal()", available: true, critical: true, test: "testAddGlobal" },
            { name: "instantiate()", available: false, critical: true, test: "testInstantiate" },
            { name: "addFunction()", available: true, critical: false, test: "testAddFunction" },
            { name: "gc()", available: false, critical: false, test: "testGC" }
        ];
        
        function renderAPIs() {
            const tbody = document.getElementById('apiTableBody');
            let html = "";
            
            apis.forEach(api => {
                const status = api.available ? "present" : "missing";
                const statusText = api.available ? "‚úÖ Dispon√≠vel" : "‚ùå Ausente";
                const criticalText = api.critical ? "CR√çTICO" : "Importante";
                
                html += `
                <tr>
                    <td><strong>${api.name}</strong></td>
                    <td><span class="status-badge status-${status}">${statusText}</span></td>
                    <td>${criticalText}</td>
                    <td><button class="test-button" onclick="${api.test}()" ${!api.available ? 'disabled' : ''}>Testar</button></td>
                </tr>`;
            });
            
            tbody.innerHTML = html;
        }
        
        // ============================================
        // FUN√á√ïES DE TESTE
        // ============================================
        
        function logToConsole(message, consoleId = "apiTestOutput") {
            const consoleDiv = document.getElementById(consoleId);
            const timestamp = new Date().toLocaleTimeString();
            consoleDiv.innerHTML += `[${timestamp}] ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function clearConsole(consoleId = "apiTestOutput") {
            document.getElementById(consoleId).innerHTML = "";
        }
        
        // Testes de APIs
        function testWasmBuilder() {
            clearConsole();
            logToConsole("üß™ Testando WasmModuleBuilder...");
            
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder n√£o dispon√≠vel");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                logToConsole("‚úÖ WasmModuleBuilder instanciado");
                
                const proto = Object.getPrototypeOf(builder);
                const methods = Object.getOwnPropertyNames(proto);
                logToConsole(`üìã ${methods.length} m√©todos dispon√≠veis`);
                
                methods.forEach(method => {
                    if (typeof builder[method] === 'function') {
                        logToConsole(`   ‚úì ${method}()`);
                    }
                });
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`);
            }
        }
        
        function testWebAssembly() {
            clearConsole();
            logToConsole("üß™ Testando WebAssembly...");
            
            if (typeof WebAssembly === 'undefined') {
                logToConsole("‚ùå WebAssembly n√£o est√° dispon√≠vel globalmente");
                
                // Tentar encontrar em outros escopos
                const scopes = ['window', 'self', 'globalThis', 'this'];
                scopes.forEach(scope => {
                    try {
                        if (eval(`typeof ${scope}.WebAssembly !== 'undefined'`)) {
                            logToConsole(`‚ö†Ô∏è WebAssembly encontrado em: ${scope}`);
                        }
                    } catch (e) {}
                });
                
                return;
            }
            
            logToConsole("‚úÖ WebAssembly dispon√≠vel");
            logToConsole(`   Module: ${typeof WebAssembly.Module}`);
            logToConsole(`   Instance: ${typeof WebAssembly.Instance}`);
            logToConsole(`   Global: ${typeof WebAssembly.Global}`);
        }
        
        function testAddStruct() {
            clearConsole();
            logToConsole("üß™ Testando addStruct()...");
            
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                
                // Struct simples
                const structIndex = builder.addStruct([
                    { type: 0x7f, mutable: true } // kWasmI32
                ]);
                
                logToConsole(`‚úÖ Struct criada com √≠ndice: ${structIndex}`);
                
                // Testar limites
                try {
                    const manyFields = new Array(1000).fill({ type: 0x7f, mutable: true });
                    const bigStructIndex = builder.addStruct(manyFields);
                    logToConsole(`‚ö†Ô∏è Struct grande criada: ${bigStructIndex} (1000 campos)`);
                } catch (e) {
                    logToConsole(`‚úÖ Comportamento esperado: ${e.message}`);
                }
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`);
            }
        }
        
        function testAllAPIs() {
            clearConsole();
            logToConsole("üß™ Testando todas as APIs...");
            
            apis.forEach(api => {
                if (api.test && typeof window[api.test] === 'function') {
                    logToConsole(`\nüîß Testando ${api.name}...`);
                    try {
                        window[api.test]();
                    } catch (e) {
                        logToConsole(`‚ùå Erro: ${e.message}`);
                    }
                }
            });
        }
        
        // ============================================
        // EXPLOITS BASEADOS NOS TESTES
        // ============================================
        
        function runStructConfusion() {
            clearConsole("exploitOutput");
            logToConsole("üéØ Executando Type Confusion em Structs...", "exploitOutput");
            
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio", "exploitOutput");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                logToConsole("Criando structs similares para type confusion...", "exploitOutput");
                
                // Criar grupos de structs similares
                const groupA = [];
                const groupB = [];
                
                for (let i = 0; i < 50; i++) {
                    // Grupo A: i32 primeiro
                    const structA = builder.addStruct([
                        { type: 0x7f, mutable: true }, // i32
                        { type: 0x7e, mutable: false }  // i64
                    ]);
                    groupA.push(structA);
                    
                    // Grupo B: i64 primeiro
                    const structB = builder.addStruct([
                        { type: 0x7e, mutable: false }, // i64
                        { type: 0x7f, mutable: true }   // i32
                    ]);
                    groupB.push(structB);
                }
                
                logToConsole(`‚úÖ Criados ${groupA.length} structs Grupo A`, "exploitOutput");
                logToConsole(`‚úÖ Criados ${groupB.length} structs Grupo B`, "exploitOutput");
                
                // Verificar se h√° padr√£o nos √≠ndices
                const allIndices = [...groupA, ...groupB];
                const hasPattern = allIndices.every((val, idx) => val === idx);
                
                if (hasPattern) {
                    logToConsole("‚úÖ √çndices seguem padr√£o sequencial", "exploitOutput");
                } else {
                    logToConsole("‚ö†Ô∏è √çndices N√ÉO seguem padr√£o esperado!", "exploitOutput");
                    logToConsole("üö® POSS√çVEL TYPE CONFUSION DETECTADA!", "exploitOutput");
                }
                
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`, "exploitOutput");
            }
        }
        
        function runUseAfterFree() {
            clearConsole("exploitOutput");
            logToConsole("üéØ Executando Use-After-Free em TypeDefinition...", "exploitOutput");
            
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio", "exploitOutput");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                
                // Criar muitas structs
                logToConsole("Criando 1000 structs...", "exploitOutput");
                const structs = [];
                
                for (let i = 0; i < 1000; i++) {
                    const fields = [
                        { type: 0x7f + (i % 4), mutable: true }
                    ];
                    structs.push(builder.addStruct(fields));
                }
                
                logToConsole(`‚úÖ ${structs.length} structs criadas`, "exploitOutput");
                
                // Liberar refer√™ncias
                logToConsole("Liberando refer√™ncias...", "exploitOutput");
                structs.length = 0;
                
                // For√ßar GC se dispon√≠vel
                if (typeof gc !== 'undefined') {
                    gc();
                    logToConsole("‚úÖ GC for√ßado", "exploitOutput");
                }
                
                // Criar novas structs (potencial reutiliza√ß√£o de mem√≥ria)
                logToConsole("Criando novas structs ap√≥s GC...", "exploitOutput");
                const newStructs = [];
                
                for (let i = 0; i < 500; i++) {
                    newStructs.push(builder.addStruct([
                        { type: 0x7f, mutable: true }
                    ]));
                }
                
                logToConsole(`‚úÖ ${newStructs.length} novas structs criadas`, "exploitOutput");
                logToConsole("üìä An√°lise: Se √≠ndices forem reutilizados, h√° UAF poss√≠vel", "exploitOutput");
                
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`, "exploitOutput");
            }
        }
        
        function runHeapSpray() {
            clearConsole("exploitOutput");
            logToConsole("üéØ Executando Heap Spraying com Arrays...", "exploitOutput");
            
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio", "exploitOutput");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                
                // Spray de arrays
                logToConsole("Criando 2000 arrays para heap spraying...", "exploitOutput");
                const arrays = [];
                
                for (let i = 0; i < 2000; i++) {
                    const arrayType = builder.addArray(0x7f, true); // i32 mutable
                    arrays.push(arrayType);
                    
                    if (i % 500 === 0) {
                        logToConsole(`   Progresso: ${i}/2000 arrays...`, "exploitOutput");
                    }
                }
                
                logToConsole(`‚úÖ ${arrays.length} arrays criados`, "exploitOutput");
                logToConsole("üéØ Heap preparado para explora√ß√£o", "exploitOutput");
                
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`, "exploitOutput");
            }
        }
        
        // ============================================
        // TESTES BASEADOS NO C√ìDIGO-FONTE
        // ============================================
        
        function runPSTest(testName) {
            clearConsole("testOutput");
            
            switch(testName) {
                case 'struct-basic':
                    logToConsole("üèóÔ∏è Executando Teste de Struct B√°sica...", "testOutput");
                    testStructBasic();
                    break;
                case 'global-ref':
                    logToConsole("üîó Executando Teste de Global com Refer√™ncia...", "testOutput");
                    testGlobalRef();
                    break;
                case 'stress-test':
                    logToConsole("üí• Executando Teste de Estresse...", "testOutput");
                    runStressTest();
                    break;
            }
        }
        
        function testStructBasic() {
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio", "testOutput");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                
                // Como no gc/struct.js
                const structIndex = builder.addStruct([
                    { type: 0x7f, mutable: true },  // i32
                    { type: 0x7e, mutable: false }, // i64
                    { type: 0x7d, mutable: true },  // f32
                    { type: 0x7c, mutable: false }  // f64
                ]);
                
                logToConsole(`‚úÖ Struct criada: √≠ndice ${structIndex}`, "testOutput");
                logToConsole("üìä 4 campos: i32(mut), i64, f32(mut), f64", "testOutput");
                
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`, "testOutput");
            }
        }
        
        function testGlobalRef() {
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio", "testOutput");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                
                // Como no js-api/global.js
                const structIndex = builder.addStruct([
                    { type: 0x7e, mutable: true } // i64
                ]);
                
                // Criar global com refnull
                builder.addGlobal(
                    { type: 'refnull', heapType: structIndex },
                    true,
                    false,
                    [0xd0, ...Array(5).fill(0)] // kExprRefNull + encoded type index
                ).exportAs("test_global");
                
                logToConsole(`‚úÖ Global com refnull criada`, "testOutput");
                logToConsole(`   Tipo: refnull (struct ${structIndex})`, "testOutput");
                logToConsole(`   Mut√°vel: sim`, "testOutput");
                
            } catch (e) {
                logToConsole(`‚ùå Erro: ${e.message}`, "testOutput");
            }
        }
        
        function runStressTest() {
            if (typeof WasmModuleBuilder === 'undefined') {
                logToConsole("‚ùå WasmModuleBuilder necess√°rio", "testOutput");
                return;
            }
            
            try {
                const builder = new WasmModuleBuilder();
                let successCount = 0;
                let errorCount = 0;
                
                logToConsole("üí• Iniciando teste de estresse...", "testOutput");
                
                // Testar cria√ß√£o massiva
                for (let i = 0; i < 100; i++) {
                    try {
                        // Variar tipos e configura√ß√µes
                        const fieldCount = 1 + (i % 10);
                        const fields = [];
                        
                        for (let j = 0; j < fieldCount; j++) {
                            fields.push({
                                type: 0x7f + (j % 4), // Rotacionar tipos
                                mutable: j % 2 === 0
                            });
                        }
                        
                        builder.addStruct(fields);
                        successCount++;
                        
                        if (i % 20 === 0) {
                            logToConsole(`   Progresso: ${i}/100...`, "testOutput");
                        }
                    } catch (e) {
                        errorCount++;
                    }
                }
                
                logToConsole("üìä Resultados do teste de estresse:", "testOutput");
                logToConsole(`   ‚úÖ Sucessos: ${successCount}`, "testOutput");
                logToConsole(`   ‚ùå Erros: ${errorCount}`, "testOutput");
                logToConsole(`   üìà Taxa de sucesso: ${(successCount / 100 * 100).toFixed(1)}%`, "testOutput");
                
            } catch (e) {
                logToConsole(`üí• ERRO CR√çTICO: ${e.message}`, "testOutput");
            }
        }
        
        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar estrutura de arquivos
            document.getElementById('fileTree').innerHTML = renderFileTree(fileStructure);
            
            // Inicializar vulnerabilidades
            renderVulnerabilities();
            
            // Inicializar APIs
            renderAPIs();
            
            // An√°lise inicial
            logToConsole("üü¢ Analisador de WebAssembly PS5 inicializado", "apiTestOutput");
            logToConsole("üîç Situa√ß√£o: WasmModuleBuilder ‚úì | WebAssembly ‚úó", "apiTestOutput");
            logToConsole("üéØ Foco: Explorar vulnerabilidades no WasmModuleBuilder", "apiTestOutput");
            
            // Testar ambiente
            setTimeout(() => {
                testWebAssembly();
                testWasmBuilder();
            }, 1000);
        });
    </script>
</body>
</html>
