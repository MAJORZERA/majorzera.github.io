<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste PS5 WasmModuleBuilder Wrapper</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .panel h2 {
            margin-top: 0;
            color: #00ff9d;
            border-bottom: 2px solid rgba(0, 255, 157, 0.3);
            padding-bottom: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }
        
        button.warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }
        
        .console {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            color: #d4d4d4;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .log-timestamp {
            color: #6a9955;
        }
        
        .log-info { color: #9cdcfe; }
        .log-success { color: #4ec9b0; }
        .log-warning { color: #ffd700; }
        .log-error { color: #f48771; }
        
        .api-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .api-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .api-card.available {
            border-color: #00ff9d;
        }
        
        .api-card.unavailable {
            border-color: #ff416c;
            opacity: 0.7;
        }
        
        .api-card h4 {
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-area {
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .test-area h3 {
            color: #00ff9d;
            margin-bottom: 15px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }
        
        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ PS5 WasmModuleBuilder Wrapper</h1>
        
        <div class="panel">
            <h2>üì¶ Carregamento</h2>
            <p>Este wrapper adapta o <code>wasm-module-builder.js</code> do PS5 para funcionar no navegador.</p>
            
            <div class="button-group">
                <button onclick="testWrapper()" id="testBtn">
                    <span>üß™</span> Testar Wrapper
                </button>
                <button onclick="testWasmBuilder()" id="builderBtn" disabled>
                    <span>üîß</span> Testar WasmModuleBuilder
                </button>
                <button onclick="runExploitTest()" class="warning" id="exploitBtn" disabled>
                    <span>üí£</span> Testar Exploit
                </button>
                <button onclick="clearConsole()" class="danger">
                    <span>üóëÔ∏è</span> Limpar Console
                </button>
            </div>
        </div>
        
        <div class="panel">
            <h2>‚öôÔ∏è APIs Dispon√≠veis</h2>
            <div class="api-grid" id="apiGrid">
                <!-- APIs ser√£o preenchidas dinamicamente -->
            </div>
        </div>
        
        <div class="test-area">
            <h3>üß™ Teste Manual</h3>
            <input type="text" id="testCode" placeholder="Digite c√≥digo JavaScript para testar (ex: new WasmModuleBuilder())">
            <button onclick="executeTestCode()">Executar C√≥digo</button>
        </div>
        
        <div class="panel">
            <h2>üì∫ Console de Sa√≠da</h2>
            <div class="console" id="consoleOutput">
                Aguardando inicializa√ß√£o...
            </div>
        </div>
    </div>

    <!-- Incluir o wrapper primeiro -->
    <script src="ps5-wasm-wrapper.js"></script>
    
    <script>
        // Sistema de logging
        const consoleOutput = document.getElementById('consoleOutput');
        const logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message: String(message),
                type
            };
            
            logs.push(logEntry);
            
            const typeClass = {
                info: 'log-info',
                success: 'log-success',
                warning: 'log-warning',
                error: 'log-error'
            }[type];
            
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="${typeClass}">${message}</span>
            `;
            
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
            
            // Log no console real tamb√©m
            const consoleMethod = {
                info: console.info,
                success: console.log,
                warning: console.warn,
                error: console.error
            }[type] || console.log;
            
            consoleMethod(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearConsole() {
            logs.length = 0;
            consoleOutput.innerHTML = '';
            log('Console limpo', 'success');
        }
        
        // Testar wrapper
        async function testWrapper() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.innerHTML = '<span>‚è≥</span> Testando...';
            
            log('üß™ Testando wrapper...', 'info');
            
            try {
                // Verificar se wrapper carregou
                if (typeof PS5WasmWrapper === 'undefined') {
                    throw new Error('Wrapper n√£o carregado');
                }
                
                log('‚úÖ Wrapper carregado', 'success');
                
                // Testar carregamento do builder
                log('Carregando WasmModuleBuilder...', 'info');
                
                // O wrapper j√° deve ter carregado automaticamente
                if (typeof WasmModuleBuilder === 'undefined') {
                    // Tentar carregar manualmente
                    const success = await PS5WasmWrapper.loadPS5WasmBuilder();
                    
                    if (!success) {
                        PS5WasmWrapper.createBasicWasmModuleBuilder();
                        log('‚ö†Ô∏è Usando implementa√ß√£o b√°sica', 'warning');
                    }
                }
                
                if (typeof WasmModuleBuilder !== 'undefined') {
                    log('‚úÖ WasmModuleBuilder dispon√≠vel!', 'success');
                    
                    // Habilitar bot√µes
                    document.getElementById('builderBtn').disabled = false;
                    document.getElementById('exploitBtn').disabled = false;
                    
                    // Atualizar APIs
                    updateAPIGrid();
                    
                } else {
                    throw new Error('WasmModuleBuilder n√£o definido ap√≥s carregamento');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = '<span>üß™</span> Testar Wrapper';
            }
        }
        
        // Testar WasmModuleBuilder
        function testWasmBuilder() {
            const builderBtn = document.getElementById('builderBtn');
            builderBtn.disabled = true;
            builderBtn.innerHTML = '<span>‚è≥</span> Testando...';
            
            log('üîß Testando WasmModuleBuilder...', 'info');
            
            try {
                if (typeof WasmModuleBuilder === 'undefined') {
                    throw new Error('WasmModuleBuilder n√£o dispon√≠vel');
                }
                
                // Testar cria√ß√£o
                const builder = new WasmModuleBuilder();
                log('‚úÖ Inst√¢ncia criada', 'success');
                
                // Testar m√©todos
                log('Testando m√©todos...', 'info');
                
                // addStruct
                if (typeof builder.addStruct === 'function') {
                    const structIndex = builder.addStruct([
                        { type: 0x7f, mutable: true } // i32
                    ]);
                    log(`‚úÖ addStruct() funcionou: √≠ndice ${structIndex}`, 'success');
                } else {
                    log('‚ùå addStruct() n√£o dispon√≠vel', 'error');
                }
                
                // addGlobal
                if (typeof builder.addGlobal === 'function') {
                    const global = builder.addGlobal(
                        { type: 0x7f, mutable: true },
                        false,
                        [0x41, 0x00] // i32.const 0
                    );
                    log('‚úÖ addGlobal() funcionou', 'success');
                }
                
                // instantiate
                if (typeof builder.instantiate === 'function') {
                    try {
                        const instance = builder.instantiate();
                        log('‚úÖ instantiate() funcionou', 'success');
                    } catch (e) {
                        log(`‚ö†Ô∏è instantiate() falhou (esperado sem WebAssembly): ${e.message}`, 'warning');
                    }
                }
                
                // Listar m√©todos dispon√≠veis
                const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(builder))
                    .filter(m => typeof builder[m] === 'function');
                
                log(`üìã ${methods.length} m√©todos dispon√≠veis: ${methods.slice(0, 10).join(', ')}${methods.length > 10 ? '...' : ''}`, 'info');
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            } finally {
                builderBtn.disabled = false;
                builderBtn.innerHTML = '<span>üîß</span> Testar WasmModuleBuilder';
            }
        }
        
        // Testar exploit
        function runExploitTest() {
            const exploitBtn = document.getElementById('exploitBtn');
            exploitBtn.disabled = true;
            exploitBtn.innerHTML = '<span>‚è≥</span> Executando...';
            
            log('üí£ Testando exploit b√°sico...', 'warning');
            
            try {
                if (typeof WasmModuleBuilder === 'undefined') {
                    throw new Error('WasmModuleBuilder necess√°rio');
                }
                
                // Teste de type confusion
                log('Criando m√∫ltiplas structs...', 'info');
                const builder = new WasmModuleBuilder();
                const structs = [];
                
                // Criar structs com layouts diferentes
                for (let i = 0; i < 100; i++) {
                    const fields = [
                        { type: 0x7f + (i % 4), mutable: true },
                        { type: 0x7f, mutable: false }
                    ];
                    const idx = builder.addStruct(fields);
                    structs.push(idx);
                    
                    if (i % 25 === 0) {
                        log(`   Progresso: ${i}/100 structs...`, 'info');
                    }
                }
                
                log(`‚úÖ ${structs.length} structs criadas`, 'success');
                
                // Verificar padr√£o
                const hasPattern = structs.every((val, idx) => val === idx);
                
                if (hasPattern) {
                    log('‚úÖ √çndices seguem padr√£o sequencial', 'success');
                } else {
                    log('‚ö†Ô∏è √çndices N√ÉO seguem padr√£o! Poss√≠vel comportamento anormal', 'warning');
                }
                
                // Testar heap spraying
                log('Testando heap spraying com globais...', 'info');
                const globals = [];
                
                for (let i = 0; i < 50; i++) {
                    const global = builder.addGlobal(
                        { type: 0x7f, mutable: true },
                        false,
                        [0x41, i] // i32.const i
                    ).exportAs(`global_${i}`);
                    globals.push(global);
                }
                
                log(`‚úÖ ${globals.length} globais criadas`, 'success');
                
                // An√°lise
                log('üìä An√°lise do exploit:', 'info');
                log('   ‚Ä¢ Structs criadas: ‚úì', 'success');
                log('   ‚Ä¢ Globais criadas: ‚úì', 'success');
                log('   ‚Ä¢ Heap preparado para type confusion', 'warning');
                log('   ‚Ä¢ Pr√≥ximo: Testar use-after-free', 'info');
                
            } catch (error) {
                log(`‚ùå Erro no exploit: ${error.message}`, 'error');
            } finally {
                exploitBtn.disabled = false;
                exploitBtn.innerHTML = '<span>üí£</span> Testar Exploit';
            }
        }
        
        // Atualizar grid de APIs
        function updateAPIGrid() {
            const apiGrid = document.getElementById('apiGrid');
            
            if (typeof WasmModuleBuilder === 'undefined') {
                apiGrid.innerHTML = '<div class="api-card unavailable"><h4>‚ùå WasmModuleBuilder</h4><p>N√£o dispon√≠vel</p></div>';
                return;
            }
            
            // Testar inst√¢ncia para obter m√©todos
            let methods = [];
            try {
                const builder = new WasmModuleBuilder();
                methods = Object.getOwnPropertyNames(Object.getPrototypeOf(builder))
                    .filter(m => typeof builder[m] === 'function');
            } catch (e) {
                methods = ['addStruct', 'addGlobal', 'instantiate', 'addFunction'];
            }
            
            const criticalMethods = ['addStruct', 'addGlobal', 'instantiate', 'addArray', 'addFunction'];
            
            let html = '';
            
            // WasmModuleBuilder
            html += `
                <div class="api-card available">
                    <h4>‚úÖ WasmModuleBuilder</h4>
                    <p>Classe principal</p>
                    <small>${methods.length} m√©todos</small>
                </div>
            `;
            
            // M√©todos cr√≠ticos
            criticalMethods.forEach(method => {
                const available = methods.includes(method);
                html += `
                    <div class="api-card ${available ? 'available' : 'unavailable'}">
                        <h4>${available ? '‚úÖ' : '‚ùå'} ${method}()</h4>
                        <p>${getMethodDescription(method)}</p>
                    </div>
                `;
            });
            
            apiGrid.innerHTML = html;
        }
        
        function getMethodDescription(method) {
            const descriptions = {
                'addStruct': 'Adiciona struct ao m√≥dulo',
                'addGlobal': 'Adiciona global ao m√≥dulo',
                'instantiate': 'Instancia o m√≥dulo',
                'addArray': 'Adiciona array ao m√≥dulo',
                'addFunction': 'Adiciona fun√ß√£o ao m√≥dulo'
            };
            return descriptions[method] || 'M√©todo do WasmModuleBuilder';
        }
        
        // Executar c√≥digo de teste manual
        function executeTestCode() {
            const codeInput = document.getElementById('testCode');
            const code = codeInput.value.trim();
            
            if (!code) return;
            
            log(`$ ${code}`, 'info');
            
            try {
                const result = eval(code);
                if (result !== undefined) {
                    log(`‚Üí ${result}`, 'success');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, 'error');
            }
            
            codeInput.value = '';
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üîÑ PS5 WasmModuleBuilder Wrapper inicializado', 'success');
            log('Clique em "Testar Wrapper" para come√ßar', 'info');
            
            // Tentar detectar automaticamente
            setTimeout(() => {
                if (typeof WasmModuleBuilder !== 'undefined') {
                    log('‚úÖ WasmModuleBuilder detectado automaticamente!', 'success');
                    updateAPIGrid();
                    document.getElementById('builderBtn').disabled = false;
                    document.getElementById('exploitBtn').disabled = false;
                }
            }, 2000);
        });
    </script>
</body>
</html>
