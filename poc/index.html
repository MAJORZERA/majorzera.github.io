<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste WebAssembly PS5 - Com Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4CAF50;
        }
        
        .discovery {
            background-color: #e8f5e9;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .discovery h2 {
            color: #2e7d32;
            margin-top: 0;
        }
        
        .test-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            min-height: 80px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            margin: 8px 8px 8px 0;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #0b7dda;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background-color: #9e9e9e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.danger {
            background-color: #f44336;
        }
        
        button.danger:hover {
            background-color: #d32f2f;
        }
        
        button.success {
            background-color: #4CAF50;
        }
        
        button.success:hover {
            background-color: #388e3c;
        }
        
        button.warning {
            background-color: #ff9800;
        }
        
        button.warning:hover {
            background-color: #f57c00;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .status {
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 6px;
            font-weight: bold;
            display: none;
        }
        
        .status.error {
            background-color: #ffebee;
            color: #c62828;
            border: 2px solid #ef9a9a;
            display: block;
        }
        
        .status.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #a5d6a7;
            display: block;
        }
        
        .status.warning {
            background-color: #fff3e0;
            color: #ef6c00;
            border: 2px solid #ffcc80;
            display: block;
        }
        
        .info-box {
            background-color: #e3f2fd;
            border-left: 5px solid #2196F3;
            padding: 18px;
            margin: 20px 0;
            border-radius: 0 6px 6px 0;
        }
        
        h2 {
            color: #444;
            margin: 20px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        h3 {
            color: #555;
            margin: 15px 0 10px 0;
        }
        
        ul, ol {
            margin-left: 25px;
            margin-bottom: 15px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        code {
            background-color: #f5f5f5;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #e0e0e0;
        }
        
        pre {
            background-color: #263238;
            color: #e0e0e0;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 15px 0;
            font-size: 13px;
        }
        
        .key-finding {
            background-color: #fffde7;
            border: 2px solid #ffd54f;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste WebAssembly PS5 - DESCOBERTA IMPORTANTE</h1>
        
        <div class="discovery">
            <h2>üéØ DESCOBERTA: WebAssembly EXISTE no PS5!</h2>
            <p>Encontramos evid√™ncias no WebKit do PS5:</p>
            <ul>
                <li><strong>Pasta "wasm"</strong> nos arquivos do WebKit</li>
                <li><strong>Arquivo "load_wasm.js"</strong> com c√≥digo WebAssembly funcional</li>
                <li><strong>Builder espec√≠fico</strong> para criar m√≥dulos WASM</li>
            </ul>
            
            <div class="key-finding">
                <h3>üìù C√≥digo encontrado:</h3>
                <pre><code>function createWasmModule() {
    let builder = new Builder();  // ‚úÖ Builder espec√≠fico do PS5
    // ... constru√ß√£o do m√≥dulo WASM ...
    return new WebAssembly.Module(builder.WebAssembly().get());  // ‚úÖ WebAssembly existe!
}</code></pre>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üß™ Testes de Compatibilidade</h2>
            
            <div class="button-group">
                <button onclick="testPS5Builder()" class="success">Testar Builder PS5</button>
                <button onclick="testStandardWasm()" class="warning">Testar WebAssembly Padr√£o</button>
                <button onclick="testPocCompatibility()">Testar Compatibilidade POC</button>
                <button onclick="clearAll()" class="danger">Limpar Tudo</button>
            </div>
            
            <div id="output" class="result-box">
                Aguardando testes...
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîß Teste do POC.js Adaptado</h2>
            
            <div class="info-box">
                <p>O POC.js original usa <code>WasmModuleBuilder</code> mas o PS5 usa <code>Builder</code>.</p>
                <p>Vamos tentar adaptar o c√≥digo para a API do PS5.</p>
            </div>
            
            <button onclick="runAdaptedPoc()" class="warning">Executar POC Adaptado</button>
            
            <div id="pocOutput" class="result-box">
                Sa√≠da do POC adaptado aparecer√° aqui...
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìã Informa√ß√µes do Sistema</h2>
            <button onclick="showSystemInfo()">Mostrar Info Detalhada</button>
            
            <div id="systemInfo" class="result-box">
                Informa√ß√µes do sistema aparecer√£o aqui...
            </div>
        </div>
        
        <div id="status" class="status"></div>
    </div>

    <script>
        // Elementos
        const output = document.getElementById('output');
        const pocOutput = document.getElementById('pocOutput');
        const systemInfo = document.getElementById('systemInfo');
        const status = document.getElementById('status');
        
        // Utilit√°rios
        function log(text, element = output) {
            element.textContent += text + '\n';
            element.scrollTop = element.scrollHeight;
        }
        
        function clear(elementId = null) {
            if (elementId) {
                document.getElementById(elementId).textContent = '';
            } else {
                output.textContent = '';
                pocOutput.textContent = '';
                systemInfo.textContent = '';
            }
            status.style.display = 'none';
        }
        
        function showStatus(msg, type) {
            status.textContent = msg;
            status.className = `status ${type}`;
        }
        
        // Testar Builder do PS5
        async function testPS5Builder() {
            clear();
            showStatus('Testando Builder do PS5...', 'warning');
            
            log('=== TESTE BUILDER PS5 ===');
            log('Baseado no arquivo load_wasm.js encontrado');
            log('');
            
            // Verificar se Builder existe
            log('1. Verificando Builder...');
            if (typeof Builder === 'undefined') {
                log('   ‚ùå Builder n√£o encontrado globalmente');
                log('   Tentando m√©todos alternativos...');
                
                // Tentar encontrar de outras formas
                const globalObjects = ['Builder', 'WasmBuilder', 'WebAssemblyBuilder', 'wasmBuilder'];
                let found = false;
                
                for (const objName of globalObjects) {
                    try {
                        if (eval(`typeof ${objName} !== 'undefined'`)) {
                            log(`   ‚úÖ ${objName} encontrado!`);
                            found = true;
                            break;
                        }
                    } catch (e) {}
                }
                
                if (!found) {
                    log('   ‚ùå Nenhum builder encontrado');
                    log('');
                    log('‚ö†Ô∏è  Builder pode estar em escopo diferente');
                    log('   ou requer inicializa√ß√£o espec√≠fica.');
                }
            } else {
                log('   ‚úÖ Builder encontrado!');
                log(`   Tipo: ${typeof Builder}`);
                log(`   Construtor: ${Builder.prototype?.constructor?.name || 'desconhecido'}`);
            }
            
            log('');
            log('2. Verificando m√©todos do Builder...');
            
            // Testar m√©todos comuns de builders WASM
            const testMethods = async () => {
                try {
                    // Tentar criar builder como no exemplo
                    const builder = new Builder();
                    log('   ‚úÖ new Builder() funcionou');
                    
                    // Verificar m√©todos
                    const methods = ['Type', 'Function', 'Export', 'Code', 'WebAssembly'];
                    methods.forEach(method => {
                        if (typeof builder[method] === 'function') {
                            log(`   ‚úÖ builder.${method}() dispon√≠vel`);
                        } else {
                            log(`   ‚ùå builder.${method}() n√£o dispon√≠vel`);
                        }
                    });
                    
                    return true;
                } catch (error) {
                    log(`   ‚ùå Erro ao criar Builder: ${error.message}`);
                    return false;
                }
            };
            
            if (typeof Builder !== 'undefined') {
                await testMethods();
            }
            
            log('');
            log('3. Tentando criar m√≥dulo WASM...');
            
            try {
                // Tentativa de criar m√≥dulo simples
                const wasmCode = new Uint8Array([
                    0x00, 0x61, 0x73, 0x6d, // magic
                    0x01, 0x00, 0x00, 0x00, // version
                    0x01, 0x04, 0x01, 0x60, // type section
                    0x00, 0x00,             // func type
                    0x03, 0x02, 0x01, 0x00, // function section
                    0x07, 0x05, 0x01,       // export section
                    0x03, 0x61, 0x64, 0x64, // "add"
                    0x00, 0x00,             // func index
                    0x0a, 0x09, 0x01,       // code section
                    0x07, 0x00,             // func size
                    0x20, 0x00,             // get_local 0
                    0x20, 0x01,             // get_local 1
                    0x6a,                   // i32.add
                    0x0b                    // end
                ]);
                
                const module = new WebAssembly.Module(wasmCode);
                log('   ‚úÖ M√≥dulo WASM criado com WebAssembly.Module');
                
                const instance = new WebAssembly.Instance(module);
                log('   ‚úÖ Inst√¢ncia WASM criada');
                
                if (instance.exports.add) {
                    const result = instance.exports.add(5, 3);
                    log(`   ‚úÖ Fun√ß√£o executada: 5 + 3 = ${result}`);
                }
                
            } catch (error) {
                log(`   ‚ùå Erro ao criar m√≥dulo: ${error.message}`);
            }
            
            showStatus('Teste do Builder conclu√≠do', 'success');
        }
        
        // Testar WebAssembly padr√£o
        function testStandardWasm() {
            clear();
            showStatus('Testando WebAssembly padr√£o...', 'warning');
            
            log('=== WEBASSEMBLY PADR√ÉO ===');
            log('');
            
            // Verificar APIs WebAssembly
            if (typeof WebAssembly === 'undefined') {
                log('‚ùå WebAssembly n√£o est√° dispon√≠vel');
                showStatus('WebAssembly n√£o dispon√≠vel!', 'error');
                return;
            }
            
            log('‚úÖ WebAssembly dispon√≠vel');
            log('');
            
            // Listar todas as APIs WebAssembly
            const wasmAPIs = [
                'Module', 'Instance', 'Memory', 'Table', 'Global',
                'compile', 'instantiate', 'validate'
            ];
            
            log('APIs WebAssembly dispon√≠veis:');
            wasmAPIs.forEach(api => {
                const available = WebAssembly[api] !== undefined;
                log(`  ${available ? '‚úÖ' : '‚ùå'} WebAssembly.${api}`);
            });
            
            log('');
            log('=== FEATURES ESPEC√çFICAS ===');
            
            // Verificar features do POC
            const features = {
                'GC Types (structs/arrays)': false,
                'Reference Types (externref/funcref)': WebAssembly.Global !== undefined,
                'Bulk Memory Operations': false,
                'SIMD': false,
                'Multi Memory': false
            };
            
            Object.entries(features).forEach(([name, available]) => {
                log(`  ${available ? '‚úÖ' : '‚ùå'} ${name}`);
            });
            
            // Testar cria√ß√£o b√°sica
            log('');
            log('=== TESTE PR√ÅTICO ===');
            
            try {
                // Criar fun√ß√£o simples que retorna 42
                const wasmBytes = new Uint8Array([
                    0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00,
                    0x01, 0x05, 0x01, 0x60, 0x00, 0x01, 0x7f,
                    0x03, 0x02, 0x01, 0x00,
                    0x07, 0x07, 0x01, 0x03, 0x61, 0x64, 0x64, 0x00, 0x00,
                    0x0a, 0x09, 0x01, 0x07, 0x00, 0x41, 0x2a, 0x0b
                ]);
                
                const module = new WebAssembly.Module(wasmBytes);
                const instance = new WebAssembly.Instance(module);
                
                if (instance.exports.add) {
                    const result = instance.exports.add();
                    log(`‚úÖ Fun√ß√£o WASM executada: retornou ${result}`);
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`);
            }
            
            showStatus('Teste WebAssembly conclu√≠do', 'success');
        }
        
        // Testar compatibilidade com POC
        function testPocCompatibility() {
            clear();
            showStatus('Analisando compatibilidade do POC...', 'warning');
            
            log('=== AN√ÅLISE DE COMPATIBILIDADE POC.js ===');
            log('');
            
            // Requisitos do POC
            const requirements = [
                { 
                    name: 'WebAssembly b√°sico',
                    test: () => typeof WebAssembly !== 'undefined',
                    critical: true
                },
                { 
                    name: 'WebAssembly.Module',
                    test: () => WebAssembly && typeof WebAssembly.Module !== 'undefined',
                    critical: true
                },
                { 
                    name: 'WebAssembly.Instance',
                    test: () => WebAssembly && typeof WebAssembly.Instance !== 'undefined',
                    critical: true
                },
                { 
                    name: 'WebAssembly.Global (para refer√™ncias)',
                    test: () => WebAssembly && typeof WebAssembly.Global !== 'undefined',
                    critical: true
                },
                { 
                    name: 'GC Types (structs)',
                    test: () => {
                        // Tentar detectar GC types
                        try {
                            // O POC usa kWasmStructTypeForm, kWasmArrayTypeForm
                            return false; // Provavelmente n√£o dispon√≠vel
                        } catch {
                            return false;
                        }
                    },
                    critical: true,
                    note: 'Necess√°rio para o exploit funcionar'
                },
                { 
                    name: 'Fun√ß√£o load()',
                    test: () => typeof load !== 'undefined',
                    critical: false,
                    note: 'Pode ser substitu√≠da por fetch()'
                },
                { 
                    name: 'Fun√ß√£o gc()',
                    test: () => typeof gc !== 'undefined',
                    critical: false,
                    note: 'Pode afetar confiabilidade do exploit'
                },
                { 
                    name: 'Fun√ß√£o print()',
                    test: () => typeof print !== 'undefined',
                    critical: false,
                    note: 'Pode ser substitu√≠da por console.log()'
                }
            ];
            
            let allCriticalPass = true;
            
            requirements.forEach(req => {
                const passed = req.test();
                log(`${passed ? '‚úÖ' : '‚ùå'} ${req.name}`);
                
                if (!passed && req.critical) {
                    log(`   ‚ö†Ô∏è  CR√çTICO: ${req.note || 'Requisito essencial'}`);
                    allCriticalPass = false;
                } else if (!passed) {
                    log(`   ‚ÑπÔ∏è  Opcional: ${req.note || 'Pode ser contornado'}`);
                }
            });
            
            log('');
            log('=== CONCLUS√ÉO ===');
            
            if (!allCriticalPass) {
                log('‚ùå POC.js N√ÉO √â COMPAT√çVEL');
                log('   Faltam requisitos cr√≠ticos');
                log('   Principalmente GC Types para structs/references');
                showStatus('POC n√£o compat√≠vel - faltam GC Types', 'error');
            } else {
                log('‚ö†Ô∏è  POC.js PODE SER ADAPTADO');
                log('   WebAssembly b√°sico dispon√≠vel');
                log('   Mas GC Types podem n√£o estar dispon√≠veis');
                log('   O exploit pode precisar de modifica√ß√µes');
                showStatus('Compatibilidade limitada - adapta√ß√£o necess√°ria', 'warning');
            }
        }
        
        // Executar POC adaptado
        function runAdaptedPoc() {
            clear('pocOutput');
            showStatus('Executando POC adaptado...', 'warning');
            
            log('=== POC ADAPTADO PARA PS5 ===', pocOutput);
            log('Tentando usar Builder do PS5 em vez de WasmModuleBuilder', pocOutput);
            log('', pocOutput);
            
            try {
                // Vers√£o adaptada baseada no c√≥digo encontrado
                log('1. Tentando criar m√≥dulo com Builder...', pocOutput);
                
                if (typeof Builder === 'undefined') {
                    log('   ‚ùå Builder n√£o dispon√≠vel', pocOutput);
                    log('   Tentando abordagem alternativa...', pocOutput);
                    
                    // Tentar abordagem alternativa
                    log('2. Criando m√≥dulo WASM manualmente...', pocOutput);
                    
                    // C√≥digo WASM simples
                    const wasmCode = new Uint8Array([
                        0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00,
                        0x01, 0x04, 0x01, 0x60, 0x00, 0x00,
                        0x03, 0x02, 0x01, 0x00,
                        0x07, 0x08, 0x01, 0x04, 0x74, 0x65, 0x73, 0x74, 0x00, 0x00,
                        0x0a, 0x06, 0x01, 0x04, 0x00, 0x41, 0x00, 0x0b
                    ]);
                    
                    const module = new WebAssembly.Module(wasmCode);
                    log('   ‚úÖ M√≥dulo criado com sucesso', pocOutput);
                    
                    const instance = new WebAssembly.Instance(module);
                    log('   ‚úÖ Inst√¢ncia criada', pocOutput);
                    
                    log('', pocOutput);
                    log('‚ö†Ô∏è  O POC original requer:', pocOutput);
                    log('   - GC Types (structs, arrays)', pocOutput);
                    log('   - WebAssembly.Global para refer√™ncias', pocOutput);
                    log('   - Type confusion para exploit', pocOutput);
                    log('', pocOutput);
                    log('Estas features podem n√£o estar dispon√≠veis no PS5.', pocOutput);
                    
                } else {
                    log('   ‚úÖ Builder dispon√≠vel', pocOutput);
                    log('   Tentando replicar createWasmModule()...', pocOutput);
                    
                    // Tentar replicar a fun√ß√£o encontrada
                    try {
                        const builder = new Builder();
                        log('   ‚úÖ Builder instanciado', pocOutput);
                        
                        // Continuar com a constru√ß√£o...
                        log('   ‚ö†Ô∏è  API do Builder pode ser diferente', pocOutput);
                        log('   Consulte load_wasm.js para interface correta', pocOutput);
                    } catch (error) {
                        log(`   ‚ùå Erro: ${error.message}`, pocOutput);
                    }
                }
                
                log('', pocOutput);
                log('=== PR√ìXIMOS PASSOS ===', pocOutput);
                log('1. Analisar load_wasm.js para entender a API do Builder', pocOutput);
                log('2. Adaptar WasmModuleBuilder para usar Builder do PS5', pocOutput);
                log('3. Verificar se GC Types est√£o dispon√≠veis', pocOutput);
                log('4. Testar type confusion com API do PS5', pocOutput);
                
            } catch (error) {
                log(`üí• ERRO: ${error.message}`, pocOutput);
                log(error.stack, pocOutput);
            }
            
            showStatus('POC adaptado executado', 'success');
        }
        
        // Mostrar informa√ß√µes do sistema
        function showSystemInfo() {
            clear('systemInfo');
            
            log('=== SISTEMA PS5 WEBKIT ===', systemInfo);
            log('', systemInfo);
            
            // User Agent
            log(`User Agent: ${navigator.userAgent || 'N/A'}`, systemInfo);
            log(`Platform: ${navigator.platform || 'N/A'}`, systemInfo);
            log(`Vendor: ${navigator.vendor || 'N/A'}`, systemInfo);
            log(`Languages: ${JSON.stringify(navigator.languages || [])}`, systemInfo);
            
            log('', systemInfo);
            log('=== WEBASSEMBLY ===', systemInfo);
            
            if (typeof WebAssembly === 'undefined') {
                log('‚ùå N√£o dispon√≠vel', systemInfo);
            } else {
                log('‚úÖ Dispon√≠vel', systemInfo);
                
                // Detalhes
                const props = Object.getOwnPropertyNames(WebAssembly);
                log(`APIs: ${props.join(', ')}`, systemInfo);
            }
            
            log('', systemInfo);
            log('=== HARDWARE ===', systemInfo);
            
            if (navigator.hardwareConcurrency) {
                log(`CPU Cores: ${navigwareConcurrency}`, systemInfo);
            }
            
            if (navigator.deviceMemory) {
                log(`Device Memory: ${navigator.deviceMemory}GB`, systemInfo);
            }
        }
        
        // Limpar tudo
        function clearAll() {
            clear();
            showStatus('Todos os resultados limpos', 'success');
            setTimeout(() => status.style.display = 'none', 2000);
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üîç Testador WebAssembly PS5 - Com Builder', output);
            log('Baseado na descoberta de load_wasm.js', output);
            log('', output);
            log('Clique em "Testar Builder PS5" para come√ßar', output);
        });
    </script>
</body>
</html>
